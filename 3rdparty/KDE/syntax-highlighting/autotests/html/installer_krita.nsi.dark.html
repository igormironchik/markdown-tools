<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title>installer_krita.nsi</title>
<meta name="generator" content="KF5::SyntaxHighlighting - Definition (NSIS) - Theme (Breeze Dark)"/>
</head><body style="background-color:#232629;color:#cfcfc2"><pre>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifndef</span> KRITA_INSTALLER_32 <span style="color:#3f8058">&amp;</span> KRITA_INSTALLER_64
	<span style="color:#3f8058">!</span><span style="font-weight:bold">error</span> <span style="color:#f44f4f">"Either one of KRITA_INSTALLER_32 or KRITA_INSTALLER_64 must be defined."</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_32 <span style="color:#3f8058">&amp;</span> KRITA_INSTALLER_64
	<span style="color:#3f8058">!</span><span style="font-weight:bold">error</span> <span style="color:#f44f4f">"Only one of KRITA_INSTALLER_32 or KRITA_INSTALLER_64 should be defined."</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">ifndef</span> KRITA_PACKAGE_ROOT
	<span style="color:#3f8058">!</span><span style="font-weight:bold">error</span> <span style="color:#f44f4f">"KRITA_PACKAGE_ROOT should be defined and point to the root of the package files."</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_INSTALLER_BITNESS 64
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_INSTALLER_BITNESS 32
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

<span style="color:#0095ff;font-weight:bold">Unicode</span> true
# Enabling DPI awareness creates awful CJK text in some sizes<span style="color:#3f8058">,</span> so don't enable it.
<span style="color:#0095ff;font-weight:bold">ManifestDPIAware</span> false

# Krita constants <span style="color:#3f8058">(</span>can be overridden in command line params<span style="color:#3f8058">)</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> /<span style="font-weight:bold">ifndef</span> KRITA_VERSION <span style="color:#f44f4f">"0.0.0.0"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> /<span style="font-weight:bold">ifndef</span> KRITA_VERSION_DISPLAY <span style="color:#f44f4f">"test-version"</span>
#<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> /<span style="font-weight:bold">ifndef</span> KRITA_VERSION_GIT <span style="color:#f44f4f">""</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> /<span style="font-weight:bold">ifndef</span> KRITA_INSTALLER_OUTPUT_DIR <span style="color:#f44f4f">""</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> /<span style="font-weight:bold">ifndef</span> KRITA_INSTALLER_OUTPUT_NAME <span style="color:#f44f4f">"krita_x64_setup.exe"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> /<span style="font-weight:bold">ifndef</span> KRITA_INSTALLER_OUTPUT_NAME <span style="color:#f44f4f">"krita_x86_setup.exe"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

# Krita constants <span style="color:#3f8058">(</span>fixed<span style="color:#3f8058">)</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">if</span> <span style="color:#f44f4f">"${KRITA_INSTALLER_OUTPUT_DIR}"</span> <span style="color:#3f8058">==</span> <span style="color:#f44f4f">""</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_INSTALLER_OUTPUT <span style="color:#f44f4f">"${KRITA_INSTALLER_OUTPUT_NAME}"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_INSTALLER_OUTPUT <span style="color:#f44f4f">"${KRITA_INSTALLER_OUTPUT_DIR}\${KRITA_INSTALLER_OUTPUT_NAME}"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRTIA_PUBLISHER <span style="color:#f44f4f">"Krita Foundation"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_PRODUCTNAME <span style="color:#f44f4f">"Krita (x64)"</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_UNINSTALL_REGKEY <span style="color:#f44f4f">"Krita_x64"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_PRODUCTNAME <span style="color:#f44f4f">"Krita (x86)"</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_UNINSTALL_REGKEY <span style="color:#f44f4f">"Krita_x86"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

<span style="color:#0095ff;font-weight:bold">VIProductVersion</span> <span style="color:#f44f4f">"${KRITA_VERSION}"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"CompanyName"</span> <span style="color:#f44f4f">"${KRTIA_PUBLISHER}"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"FileDescription"</span> <span style="color:#f44f4f">"${KRITA_PRODUCTNAME} ${KRITA_VERSION_DISPLAY} Setup"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"FileVersion"</span> <span style="color:#f44f4f">"${KRITA_VERSION}"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"InternalName"</span> <span style="color:#f44f4f">"${KRITA_INSTALLER_OUTPUT_NAME}"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"LegalCopyright"</span> <span style="color:#f44f4f">"${KRTIA_PUBLISHER}"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"OriginalFileName"</span> <span style="color:#f44f4f">"${KRITA_INSTALLER_OUTPUT_NAME}"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"ProductName"</span> <span style="color:#f44f4f">"${KRITA_PRODUCTNAME} ${KRITA_VERSION_DISPLAY} Setup"</span>
<span style="color:#0095ff;font-weight:bold">VIAddVersionKey</span> <span style="color:#f44f4f">"ProductVersion"</span> <span style="color:#f44f4f">"${KRITA_VERSION}"</span>

<span style="color:#0095ff;font-weight:bold">BrandingText</span> <span style="color:#f44f4f">"[NSIS ${NSIS_VERSION}]  ${KRITA_PRODUCTNAME} ${KRITA_VERSION}"</span>

<span style="color:#0095ff;font-weight:bold">Name</span> <span style="color:#f44f4f">"${KRITA_PRODUCTNAME} ${KRITA_VERSION_DISPLAY}"</span>
<span style="color:#0095ff;font-weight:bold">OutFile</span> $<span style="color:#3f8058">{</span>KRITA_INSTALLER_OUTPUT<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	<span style="color:#0095ff;font-weight:bold">InstallDir</span> <span style="color:#f44f4f">"$PROGRAMFILES64\Krita (x64)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	<span style="color:#0095ff;font-weight:bold">InstallDir</span> <span style="color:#f44f4f">"$PROGRAMFILES32\Krita (x86)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
XPstyle on

<span style="color:#0095ff;font-weight:bold">ShowInstDetails</span> show
<span style="color:#0095ff;font-weight:bold">ShowUninstDetails</span> show

<span style="color:#0095ff;font-weight:bold">Var</span> KritaStartMenuFolder
<span style="color:#0095ff;font-weight:bold">Var</span> CreateDesktopIcon

<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> MUI2.nsh

<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_FINISHPAGE_NOAUTOCLOSE</span>

# Installer Pages
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_WELCOME</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_LICENSEPAGE_CHECKBOX</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_LICENSE</span> <span style="color:#f44f4f">"license_gpl-3.0.rtf"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_DIRECTORY</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_COMPONENTS</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_CUSTOMFUNCTION_PRE</span>  func_ShellExLicensePage_Init
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_HEADER_TEXT</span> <span style="color:#f44f4f">"$(ShellExLicensePageHeader)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_LICENSE</span> <span style="color:#f44f4f">"license.rtf"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENUPAGE_DEFAULTFOLDER</span> <span style="color:#f44f4f">"Krita"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENUPAGE_REGISTRY_ROOT</span> HKLM
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENUPAGE_REGISTRY_KEY</span> <span style="color:#f44f4f">"Software\Krita"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENUPAGE_REGISTRY_VALUENAME</span> <span style="color:#f44f4f">"StartMenuFolder"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENUPAGE_NODISABLE</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_STARTMENU</span> Krita $KritaStartMenuFolder
<span style="color:#0095ff;font-weight:bold">Page</span> Custom func_BeforeInstallPage_Init
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_INSTFILES</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_FINISH</span>

# Uninstaller Pages
<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> <span style="color:#9500ff;font-weight:bold">MUI_PAGE_CUSTOMFUNCTION_PRE</span> un.func_UnintallFirstpage_Init
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_UNPAGE_CONFIRM</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_UNPAGE_INSTFILES</span>

# Languages
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_LANGUAGE</span> <span style="color:#f44f4f">"English"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_LANGUAGE</span> <span style="color:#f44f4f">"TradChinese"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_LANGUAGE</span> <span style="color:#f44f4f">"SimpChinese"</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> Sections.nsh
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> LogicLib.nsh
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> x64.nsh
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> WinVer.nsh
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> WordFunc.nsh

<span style="color:#3f8058">!</span><span style="font-weight:bold">define</span> KRITA_SHELLEX_DIR <span style="color:#f44f4f">"$INSTDIR\shellex"</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"include\FileExists2.nsh"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"include\IsFileInUse.nsh"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"krita_versions_detect.nsh"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"krita_shell_integration.nsh"</span>

<span style="color:#0095ff;font-weight:bold">Var</span> KritaMsiProductX86
<span style="color:#0095ff;font-weight:bold">Var</span> KritaMsiProductX64
<span style="color:#0095ff;font-weight:bold">Var</span> KritaNsisVersion
<span style="color:#0095ff;font-weight:bold">Var</span> KritaNsisBitness
<span style="color:#0095ff;font-weight:bold">Var</span> KritaNsisInstallLocation

<span style="color:#0095ff;font-weight:bold">Var</span> PrevShellExInstallLocation
<span style="color:#0095ff;font-weight:bold">Var</span> PrevShellExStandalone

<span style="color:#0095ff;font-weight:bold">Var</span> UninstallShellExStandalone

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"-Remove_shellex"</span> SEC_remove_shellex
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $PrevShellExInstallLocation <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">AndIf</span><span style="color:#3f8058">}</span> $PrevShellExStandalone <span style="color:#3f8058">==</span> 1
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">AndIf</span><span style="color:#3f8058">}</span> $KritaNsisVersion <span style="color:#3f8058">==</span> <span style="color:#f44f4f">""</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">AndIf</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>FileExists<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$PrevShellExInstallLocation\uninstall.exe"</span>
		push $R0
		<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemovingShellEx)"</span>
		<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> listonly
		<span style="color:#0095ff;font-weight:bold">ExecWait</span> <span style="color:#f44f4f">"$PrevShellExInstallLocation\uninstall.exe /S _?=$PrevShellExInstallLocation"</span> $R0
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">!=</span> 0
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(RemoveShellExFailed)"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> both
			<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemoveShellExFailed)"</span>
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Delete</span> <span style="color:#f44f4f">"$PrevShellExInstallLocation\uninstall.exe"</span>
		<span style="color:#0095ff;font-weight:bold">RMDir</span> /REBOOTOK <span style="color:#f44f4f">"$PrevShellExInstallLocation"</span>
		<span style="color:#0095ff;font-weight:bold">SetRebootFlag</span> false
		<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> lastused
		<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemoveShellExDone)"</span>
		pop $R0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"$(SectionRemoveOldVer)"</span> SEC_remove_old_version
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaNsisInstallLocation <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">AndIf</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>FileExists<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$KritaNsisInstallLocation\uninstall.exe"</span>
		push $R0
		<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemovingOldVer)"</span>
		<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> listonly
		<span style="color:#0095ff;font-weight:bold">ExecWait</span> <span style="color:#f44f4f">"$KritaNsisInstallLocation\uninstall.exe /S _?=$KritaNsisInstallLocation"</span> $R0
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">!=</span> 0
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(RemoveOldVerFailed)"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> both
			<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemoveOldVerFailed)"</span>
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Delete</span> <span style="color:#f44f4f">"$KritaNsisInstallLocation\uninstall.exe"</span>
		<span style="color:#0095ff;font-weight:bold">RMDir</span> /REBOOTOK <span style="color:#f44f4f">"$KritaNsisInstallLocation"</span>
		<span style="color:#0095ff;font-weight:bold">SetRebootFlag</span> false
		<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> lastused
		<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemoveOldVerDone)"</span>
		pop $R0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"-Thing"</span>
	<span style="color:#0095ff;font-weight:bold">SetOutPath</span> $INSTDIR
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"DisplayName"</span> <span style="color:#f44f4f">"${KRITA_PRODUCTNAME} ${KRITA_VERSION_DISPLAY}"</span>
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"UninstallString"</span> <span style="color:#f44f4f">"$\"</span>$INSTDIR\uninstall.exe$\<span style="color:#f44f4f">""</span>
	<span style="color:#0095ff;font-weight:bold">WriteUninstaller</span> $INSTDIR\uninstall.exe
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"DisplayVersion"</span> <span style="color:#f44f4f">"${KRITA_VERSION}"</span>
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"DisplayIcon"</span> <span style="color:#f44f4f">"$\"</span>$INSTDIR\shellex\krita.ico$\<span style="color:#f44f4f">",0"</span>
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"URLInfoAbout"</span> <span style="color:#f44f4f">"https://krita.org/"</span>
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"InstallLocation"</span> <span style="color:#f44f4f">"$INSTDIR"</span>
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                 <span style="color:#f44f4f">"Publisher"</span> <span style="color:#f44f4f">"${KRTIA_PUBLISHER}"</span>
	#WriteRegDWORD HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	#                   <span style="color:#f44f4f">"EstimatedSize"</span> 250000
	<span style="color:#0095ff;font-weight:bold">WriteRegDWORD</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                   <span style="color:#f44f4f">"NoModify"</span> 1
	<span style="color:#0095ff;font-weight:bold">WriteRegDWORD</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span> \
	                   <span style="color:#f44f4f">"NoRepair"</span> 1
	# Registry entries for version recognition
	#   InstallLocation:
	#     Where krita is installed
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Krita"</span> \
	                 <span style="color:#f44f4f">"InstallLocation"</span> <span style="color:#f44f4f">"$INSTDIR"</span>
	#   Version:
	#     Version of Krita
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Krita"</span> \
	                 <span style="color:#f44f4f">"Version"</span> <span style="color:#f44f4f">"${KRITA_VERSION}"</span>
	#   x64:
	#     Set to 1 for 64<span style="color:#3f8058">-</span>bit Krita<span style="color:#3f8058">,</span> can be missing for 32<span style="color:#3f8058">-</span>bit Krita
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	<span style="color:#0095ff;font-weight:bold">WriteRegDWORD</span> HKLM <span style="color:#f44f4f">"Software\Krita"</span> \
	                   <span style="color:#f44f4f">"x64"</span> 1
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	<span style="color:#0095ff;font-weight:bold">DeleteRegValue</span> HKLM <span style="color:#f44f4f">"Software\Krita"</span> <span style="color:#f44f4f">"x64"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
	#   InstallerLanguage:
	#     Language used by the installer <span style="color:#3f8058">(</span>to be re<span style="color:#3f8058">-</span>used for the uninstaller<span style="color:#3f8058">)</span>
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Krita"</span> \
	                 <span style="color:#f44f4f">"InstallerLanguage"</span> <span style="color:#f44f4f">"$LANGUAGE"</span>
	#   StartMenuFolder:
	#     Start Menu Folder
	#     Handled by Modern UI 2.0 <span style="color:#9500ff;font-weight:bold">MUI_PAGE_STARTMENU</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"${KRITA_PRODUCTNAME}"</span> SEC_product_main
	# TODO: Maybe switch to explicit file list<span style="color:#3f8058">?</span>
	<span style="color:#0095ff;font-weight:bold">File</span> /r /x ffmpeg.exe /x ffmpeg_README.txt /x ffmpeg_LICENSE.txt $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\bin
	<span style="color:#0095ff;font-weight:bold">File</span> /r $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\lib
	<span style="color:#0095ff;font-weight:bold">File</span> /r $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\share
	<span style="color:#0095ff;font-weight:bold">File</span> /r $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\python
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"-Main_associate"</span>
	<span style="color:#0095ff;font-weight:bold">CreateDirectory</span> $<span style="color:#3f8058">{</span>KRITA_SHELLEX_DIR<span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span>Krita_RegisterFileAssociation<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$INSTDIR\bin\krita.exe"</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"-Main_Shortcuts"</span>
	# Placing this after Krita_RegisterFileAssociation to get the icon
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENU_WRITE_BEGIN</span> Krita
		<span style="color:#0095ff;font-weight:bold">CreateDirectory</span> <span style="color:#f44f4f">"$SMPROGRAMS\$KritaStartMenuFolder"</span>
		<span style="color:#0095ff;font-weight:bold">CreateShortcut</span> <span style="color:#f44f4f">"$SMPROGRAMS\$KritaStartMenuFolder\${KRITA_PRODUCTNAME}.lnk"</span> <span style="color:#f44f4f">"$INSTDIR\bin\krita.exe"</span> <span style="color:#f44f4f">""</span> <span style="color:#f44f4f">"$INSTDIR\shellex\krita.ico"</span> 0
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_STARTMENU_WRITE_END</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $CreateDesktopIcon <span style="color:#3f8058">==</span> 1
		# <span style="color:#9500ff;font-weight:bold">For</span> the desktop icon<span style="color:#3f8058">,</span> keep the name short and omit version info
		<span style="color:#0095ff;font-weight:bold">CreateShortcut</span> <span style="color:#f44f4f">"$DESKTOP\Krita.lnk"</span> <span style="color:#f44f4f">"$INSTDIR\bin\krita.exe"</span> <span style="color:#f44f4f">""</span> <span style="color:#f44f4f">"$INSTDIR\shellex\krita.ico"</span> 0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"$(SectionShellEx)"</span> SEC_shellex
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span>Krita_RegisterComComonents<span style="color:#3f8058">}</span> 64
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span>Krita_RegisterComComonents<span style="color:#3f8058">}</span> 32

	$<span style="color:#3f8058">{</span>Krita_RegisterShellExtension<span style="color:#3f8058">}</span>

	#   ShellExtension\InstallLocation:
	#     Where the shell extension is installed
	#     <span style="color:#9500ff;font-weight:bold">If</span> installed by Krita installer<span style="color:#3f8058">,</span> this must point to shellex sub<span style="color:#3f8058">-</span>dir
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> \
	                 <span style="color:#f44f4f">"InstallLocation"</span> <span style="color:#f44f4f">"$INSTDIR\shellex"</span>
	#   ShellExtension\Version:
	#     Version of the shell extension
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> \
	                 <span style="color:#f44f4f">"Version"</span> <span style="color:#f44f4f">"${KRITASHELLEX_VERSION}"</span>
	#   ShellExtension\Standalone:
	#     0 <span style="color:#3f8058">=</span> Installed by Krita installer
	#     1 <span style="color:#3f8058">=</span> Standalone installer
	<span style="color:#0095ff;font-weight:bold">WriteRegDWORD</span> HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> \
	                   <span style="color:#f44f4f">"Standalone"</span> 0
	#   ShellExtension\KritaExePath:
	#     Path to krita.exe as specified by user or by Krita installer
	#     Empty <span style="font-weight:bold">if</span> not specified
	<span style="color:#0095ff;font-weight:bold">WriteRegStr</span> HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> \
	                 <span style="color:#f44f4f">"KritaExePath"</span> <span style="color:#f44f4f">"$INSTDIR\bin\krita.exe"</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> HAS_FFMPEG
<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"$(SectionBundledFfmpeg)"</span> SEC_ffmpeg
	<span style="color:#0095ff;font-weight:bold">File</span> /oname<span style="color:#3f8058">=</span>bin\ffmpeg.exe $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\bin\ffmpeg.exe
	<span style="color:#0095ff;font-weight:bold">File</span> /oname<span style="color:#3f8058">=</span>bin\ffmpeg_LICENSE.txt $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\bin\ffmpeg_LICENSE.txt
	<span style="color:#0095ff;font-weight:bold">File</span> /oname<span style="color:#3f8058">=</span>bin\ffmpeg_README.txt $<span style="color:#3f8058">{</span>KRITA_PACKAGE_ROOT<span style="color:#3f8058">}</span>\bin\ffmpeg_README.txt
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"-Main_refreshShell"</span>
	$<span style="color:#3f8058">{</span>RefreshShell<span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_FUNCTION_DESCRIPTION_BEGIN</span>
	#<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_DESCRIPTION_TEXT</span> $<span style="color:#3f8058">{</span>SEC_remove_shellex<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"Remove previously installed Krita Shell Integration."</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_DESCRIPTION_TEXT</span> $<span style="color:#3f8058">{</span>SEC_remove_old_version<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$(SectionRemoveOldVerDesc)"</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_DESCRIPTION_TEXT</span> $<span style="color:#3f8058">{</span>SEC_product_main<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$(SectionMainDesc)"</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_DESCRIPTION_TEXT</span> $<span style="color:#3f8058">{</span>SEC_shellex<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$(SectionShellExDesc)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> HAS_FFMPEG
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_DESCRIPTION_TEXT</span> $<span style="color:#3f8058">{</span>SEC_ffmpeg<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$(SectionBundledFfmpegDesc)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_FUNCTION_DESCRIPTION_END</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"un.$(SectionShellEx)"</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $UninstallShellExStandalone <span style="color:#3f8058">==</span> 1
		push $R0
		<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemovingShellEx)"</span>
		<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> listonly
		<span style="color:#0095ff;font-weight:bold">ExecWait</span> <span style="color:#f44f4f">"$INSTDIR\shellex\uninstall.exe /S _?=$INSTDIR\shellex"</span> $R0
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">!=</span> 0
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(RemoveShellExFailed)"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> lastused
			<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> both
			<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemoveShellExFailed)"</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Delete</span> <span style="color:#f44f4f">"$INSTDIR\shellex\uninstall.exe"</span>
		<span style="color:#0095ff;font-weight:bold">RMDir</span> /REBOOTOK <span style="color:#f44f4f">"$INSTDIR\shellex"</span>
		<span style="color:#0095ff;font-weight:bold">SetDetailsPrint</span> lastused
		<span style="color:#0095ff;font-weight:bold">DetailPrint</span> <span style="color:#f44f4f">"$(RemoveShellExDone)"</span>
		pop $R0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span>Krita_UnregisterShellExtension<span style="color:#3f8058">}</span>

		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
			$<span style="color:#3f8058">{</span>Krita_UnregisterComComonents<span style="color:#3f8058">}</span> 64
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span>Krita_UnregisterComComonents<span style="color:#3f8058">}</span> 32
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"un.Main_associate"</span>
	# TODO: Conditional<span style="color:#3f8058">,</span> use install log
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $UninstallShellExStandalone <span style="color:#3f8058">!=</span> 1
		$<span style="color:#3f8058">{</span>Krita_UnregisterFileAssociation<span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"un.Main_Shortcuts"</span>
	<span style="color:#0095ff;font-weight:bold">Delete</span> <span style="color:#f44f4f">"$DESKTOP\Krita.lnk"</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> MUI_STARTMENU_GETFOLDER Krita $KritaStartMenuFolder
	<span style="color:#0095ff;font-weight:bold">Delete</span> <span style="color:#f44f4f">"$SMPROGRAMS\$KritaStartMenuFolder\${KRITA_PRODUCTNAME}.lnk"</span>
	<span style="color:#0095ff;font-weight:bold">RMDir</span> <span style="color:#f44f4f">"$SMPROGRAMS\$KritaStartMenuFolder"</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"un.${KRITA_PRODUCTNAME}"</span>
	# TODO: Maybe switch to explicit file list or some sort of install log<span style="color:#3f8058">?</span>
	<span style="color:#0095ff;font-weight:bold">RMDir</span> /r $INSTDIR\bin
	<span style="color:#0095ff;font-weight:bold">RMDir</span> /r $INSTDIR\lib
	<span style="color:#0095ff;font-weight:bold">RMDir</span> /r $INSTDIR\share
	<span style="color:#0095ff;font-weight:bold">RMDir</span> /r $INSTDIR\python
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"un.Thing"</span>
	<span style="color:#0095ff;font-weight:bold">RMDir</span> /REBOOTOK $INSTDIR\shellex
	<span style="color:#0095ff;font-weight:bold">DeleteRegKey</span> HKLM <span style="color:#f44f4f">"Software\Krita"</span>
	<span style="color:#0095ff;font-weight:bold">DeleteRegKey</span> HKLM <span style="color:#f44f4f">"Software\Microsoft\Windows\CurrentVersion\Uninstall\${KRITA_UNINSTALL_REGKEY}"</span>
	<span style="color:#0095ff;font-weight:bold">Delete</span> $INSTDIR\uninstall.exe
	<span style="color:#0095ff;font-weight:bold">RMDir</span> /REBOOTOK $INSTDIR
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Section</span> <span style="color:#f44f4f">"un.Main_refreshShell"</span>
	$<span style="color:#3f8058">{</span>RefreshShell<span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">SectionEnd</span>

<span style="color:#0095ff;font-weight:bold">Function</span> .onInit
	<span style="color:#0095ff;font-weight:bold">SetShellVarContext</span> all
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> SetSectionFlag $<span style="color:#3f8058">{</span>SEC_product_main<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_RO<span style="color:#3f8058">}</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> SetSectionFlag $<span style="color:#3f8058">{</span>SEC_product_main<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_BOLD<span style="color:#3f8058">}</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> SetSectionFlag $<span style="color:#3f8058">{</span>SEC_remove_old_version<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_RO<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> HAS_FFMPEG
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> SetSectionFlag $<span style="color:#3f8058">{</span>SEC_ffmpeg<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_RO<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
	<span style="color:#0095ff;font-weight:bold">StrCpy</span> $CreateDesktopIcon 1 # Create desktop icon by default
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>AtLeastWin7<span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(MsgRequireWin7)"</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Abort</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>

	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
		# Language selection<span style="color:#3f8058">,</span> seems that the order is predefined.
		<span style="color:#0095ff;font-weight:bold">Push</span> <span style="color:#f44f4f">""</span> # This value is for languages auto count
		<span style="color:#0095ff;font-weight:bold">Push</span> $<span style="color:#3f8058">{</span>LANG_ENGLISH<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Push</span> English
		<span style="color:#0095ff;font-weight:bold">Push</span> $<span style="color:#3f8058">{</span>LANG_TRADCHINESE<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Push</span> <span style="color:#f44f4f">"繁體中文"</span>
		<span style="color:#0095ff;font-weight:bold">Push</span> $<span style="color:#3f8058">{</span>LANG_SIMPCHINESE<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Push</span> <span style="color:#f44f4f">"简体中文"</span>
		<span style="color:#0095ff;font-weight:bold">Push</span> A # <span style="color:#3f8058">=</span> auto count languages
		LangDLL::LangDialog <span style="color:#f44f4f">"$(^SetupCaption)"</span> <span style="color:#f44f4f">"$(SetupLangPrompt)"</span>
		<span style="color:#0095ff;font-weight:bold">Pop</span> $LANGUAGE
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $LANGUAGE <span style="color:#3f8058">==</span> <span style="color:#f44f4f">"cancel"</span>
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span>Endif<span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>

<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">SetRegView</span> 64
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(Msg64bitOn32bit)"</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Abort</span>
	$<span style="color:#3f8058">{</span>Endif<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">SetRegView</span> 64
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_YESNO</span><span style="color:#3f8058">|</span>MB_ICONEXCLAMATION <span style="color:#f44f4f">"$(Msg32bitOn64bit)"</span> \
			           /SD IDYES \
			           IDYES lbl_allow32on64
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		lbl_allow32on64:
	$<span style="color:#3f8058">{</span>Endif<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

	# Detect ancient Krita versions
	$<span style="color:#3f8058">{</span>DetectKritaMsi32bit<span style="color:#3f8058">}</span> $KritaMsiProductX86
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span>DetectKritaMsi64bit<span style="color:#3f8058">}</span> $KritaMsiProductX64
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaMsiProductX86 <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">OrIf</span><span style="color:#3f8058">}</span> $KritaMsiProductX64 <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_YESNO</span><span style="color:#3f8058">|</span><span style="color:#9500ff;font-weight:bold">MB_ICONQUESTION</span><span style="color:#3f8058">|</span>MB_DEFBUTTON1 <span style="color:#f44f4f">"$(MsgAncientVerMustBeRemoved)"</span> \
						/SD IDYES \
						IDYES lbl_removeAncientVer
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		lbl_removeAncientVer:
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaMsiProductX64 <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
			push $R0
			$<span style="color:#3f8058">{</span>MsiUninstall<span style="color:#3f8058">}</span> $KritaMsiProductX64 $R0
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">!=</span> 0
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
					$<span style="color:#3f8058">{</span>IfKritaMsi3Alpha<span style="color:#3f8058">}</span> $KritaMsiProductX64
						<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(MsgKrita3alpha1RemoveFailed)"</span>
					$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
						<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(MsgKrita2msi64bitRemoveFailed)"</span>
					$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">Abort</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			pop $R0
			<span style="color:#0095ff;font-weight:bold">StrCpy</span> $KritaMsiProductX64 <span style="color:#f44f4f">""</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaMsiProductX86 <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
			push $R0
			$<span style="color:#3f8058">{</span>MsiUninstall<span style="color:#3f8058">}</span> $KritaMsiProductX86 $R0
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">!=</span> 0
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
					<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(MsgKrita2msi32bitRemoveFailed)"</span>
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">Abort</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			pop $R0
			<span style="color:#0095ff;font-weight:bold">StrCpy</span> $KritaMsiProductX86 <span style="color:#f44f4f">""</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>

	$<span style="color:#3f8058">{</span>DetectKritaNsis<span style="color:#3f8058">}</span> $KritaNsisVersion $KritaNsisBitness $KritaNsisInstallLocation
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaNsisVersion <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
		push $R0
		$<span style="color:#3f8058">{</span>VersionCompare<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"${KRITA_VERSION}"</span> <span style="color:#f44f4f">"$KritaNsisVersion"</span> $R0
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">==</span> 0
			# Same version installed... probably
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaNsisBitness <span style="color:#3f8058">==</span> $<span style="color:#3f8058">{</span>KRITA_INSTALLER_BITNESS<span style="color:#3f8058">}</span>
				# Very likely the same version
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
					<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span><span style="color:#9500ff;font-weight:bold">MB_ICONINFORMATION</span> <span style="color:#f44f4f">"$(MsgKritaSameVerReinstall)"</span>
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
				# Very likely the same version but different arch
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
					<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span><span style="color:#9500ff;font-weight:bold">MB_ICONINFORMATION</span> <span style="color:#f44f4f">"$(MsgKrita3264bitSwap)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
					<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONEXCLAMATION <span style="color:#f44f4f">"$(MsgKrita3264bitSwap)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">ElseIf</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">==</span> 1
			# Upgrade
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $KritaNsisBitness <span style="color:#3f8058">==</span> $<span style="color:#3f8058">{</span>KRITA_INSTALLER_BITNESS<span style="color:#3f8058">}</span>
				# Silent about upgrade
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
				# Upgrade but different arch
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
					<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span><span style="color:#9500ff;font-weight:bold">MB_ICONINFORMATION</span> <span style="color:#f44f4f">"$(MsgKrita3264bitSwap)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
					<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONEXCLAMATION <span style="color:#f44f4f">"$(MsgKrita3264bitSwap)"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>
				$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">ElseIf</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">==</span> 2
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"$(MsgKritaNewerAlreadyInstalled)"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONSTOP <span style="color:#f44f4f">"Error: Unexpected state"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> SetSectionFlag $<span style="color:#3f8058">{</span>SEC_remove_old_version<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_SELECTED<span style="color:#3f8058">}</span>
		# Detect <span style="font-weight:bold">if</span> Krita is running...
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>IsFileinUse<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$KritaNsisInstallLocation\bin\krita.exe"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
				<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONEXCLAMATION <span style="color:#f44f4f">"$(MsgKritaRunning)"</span>
			$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">SetErrorLevel</span> 10
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		pop $R0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> ClearSectionFlag $<span style="color:#3f8058">{</span>SEC_remove_old_version<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_SELECTED<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">SectionSetText</span> $<span style="color:#3f8058">{</span>SEC_remove_old_version<span style="color:#3f8058">}</span> <span style="color:#f44f4f">""</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>

	# Detect standalone shell extension
	# TODO: Would it be possible to update Krita without replacing the standalone shellex<span style="color:#3f8058">?</span>
	<span style="color:#0095ff;font-weight:bold">ClearErrors</span>
	<span style="color:#0095ff;font-weight:bold">ReadRegStr</span> $PrevShellExInstallLocation HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> <span style="color:#f44f4f">"InstallLocation"</span>
	#ReadRegStr $PrevShellExVersion HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> <span style="color:#f44f4f">"Version"</span>
	<span style="color:#0095ff;font-weight:bold">ReadRegDWORD</span> $PrevShellExStandalone HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> <span style="color:#f44f4f">"Standalone"</span>
	#ReadRegStr $PrevShellExKritaExePath HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> <span style="color:#f44f4f">"KritaExePath"</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Errors<span style="color:#3f8058">}</span>
		# TODO: Assume no previous version installed or what<span style="color:#3f8058">?</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $PrevShellExStandalone <span style="color:#3f8058">==</span> 1
		#<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> SetSectionFlag $<span style="color:#3f8058">{</span>SEC_remove_shellex<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_SELECTED<span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		#<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> ClearSectionFlag $<span style="color:#3f8058">{</span>SEC_remove_shellex<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SF_SELECTED<span style="color:#3f8058">}</span>
		#SectionSetText $<span style="color:#3f8058">{</span>SEC_remove_shellex<span style="color:#3f8058">}</span> <span style="color:#f44f4f">""</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">FunctionEnd</span>

<span style="color:#0095ff;font-weight:bold">Function</span> un.onInit
	<span style="color:#0095ff;font-weight:bold">SetShellVarContext</span> all
<span style="color:#3f8058">!</span><span style="font-weight:bold">ifdef</span> KRITA_INSTALLER_64
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">SetRegView</span> 64
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">Abort</span>
	$<span style="color:#3f8058">{</span>Endif<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">else</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>RunningX64<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">SetRegView</span> 64
	$<span style="color:#3f8058">{</span>Endif<span style="color:#3f8058">}</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">endif</span>

	# Get and use installer language:
	<span style="color:#0095ff;font-weight:bold">Push</span> $0
	<span style="color:#0095ff;font-weight:bold">ReadRegStr</span> $0 HKLM <span style="color:#f44f4f">"Software\Krita"</span> <span style="color:#f44f4f">"InstallerLanguage"</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $0 <span style="color:#3f8058">!=</span> <span style="color:#f44f4f">""</span>
		<span style="color:#0095ff;font-weight:bold">StrCpy</span> $LANGUAGE $0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	<span style="color:#0095ff;font-weight:bold">Pop</span> $0

	<span style="color:#0095ff;font-weight:bold">ReadRegDWORD</span> $UninstallShellExStandalone HKLM <span style="color:#f44f4f">"Software\Krita\ShellExtension"</span> <span style="color:#f44f4f">"Standalone"</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
		# Only check here <span style="font-weight:bold">if</span> running in silent mode. It's otherwise checked in
		# un.func_UnintallFirstpage_Init in order to display a prompt in the
		# correct language.
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>IsFileinUse<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$INSTDIR\bin\krita.exe"</span>
			<span style="color:#0095ff;font-weight:bold">SetErrorLevel</span> 10
			<span style="color:#0095ff;font-weight:bold">Abort</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">FunctionEnd</span>

<span style="color:#0095ff;font-weight:bold">Function</span> un.func_UnintallFirstpage_Init
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>IsFileinUse<span style="color:#3f8058">}</span> <span style="color:#f44f4f">"$INSTDIR\bin\krita.exe"</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>Silent<span style="color:#3f8058">}</span>
			<span style="color:#0095ff;font-weight:bold">MessageBox</span> <span style="color:#9500ff;font-weight:bold">MB_OK</span><span style="color:#3f8058">|</span>MB_ICONEXCLAMATION <span style="color:#f44f4f">"$(MsgUninstallKritaRunning)"</span>
		$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">SetErrorLevel</span> 10
		<span style="color:#0095ff;font-weight:bold">Quit</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">FunctionEnd</span>

<span style="color:#0095ff;font-weight:bold">Function</span> func_ShellExLicensePage_Init
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">IfNot</span><span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SectionIsSelected<span style="color:#3f8058">}</span> $<span style="color:#3f8058">{</span>SEC_shellex<span style="color:#3f8058">}</span>
		# Skip ShellEx license page <span style="font-weight:bold">if</span> not selected
		<span style="color:#0095ff;font-weight:bold">Abort</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">FunctionEnd</span>

<span style="color:#0095ff;font-weight:bold">Var</span> hwndChkDesktopIcon

<span style="color:#0095ff;font-weight:bold">Function</span> func_DesktopShortcutPage_CheckChange
	$<span style="color:#3f8058">{</span>NSD_GetState<span style="color:#3f8058">}</span> $hwndChkDesktopIcon $CreateDesktopIcon
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $CreateDesktopIcon <span style="color:#3f8058">==</span> $<span style="color:#3f8058">{</span>BST_CHECKED<span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">StrCpy</span> $CreateDesktopIcon 1
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		<span style="color:#0095ff;font-weight:bold">StrCpy</span> $CreateDesktopIcon 0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
<span style="color:#0095ff;font-weight:bold">FunctionEnd</span>

<span style="color:#0095ff;font-weight:bold">Function</span> func_BeforeInstallPage_Init
	push $R0

	nsDialogs::Create 1018
	pop $R0
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $R0 <span style="color:#3f8058">==</span> <span style="font-weight:bold">error</span>
		<span style="color:#0095ff;font-weight:bold">Abort</span>
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	<span style="color:#3f8058">!</span><span style="font-weight:bold">insertmacro</span> <span style="color:#9500ff;font-weight:bold">MUI_HEADER_TEXT</span> <span style="color:#f44f4f">"$(ConfirmInstallPageHeader)"</span> <span style="color:#f44f4f">"$(ConfirmInstallPageDesc)"</span>

	$<span style="color:#3f8058">{</span>NSD_CreateLabel<span style="color:#3f8058">}</span> 0u 0u 300u 20u <span style="color:#f44f4f">"$(DesktopIconPageDesc2)"</span>
	pop $R0

	$<span style="color:#3f8058">{</span>NSD_CreateCheckbox<span style="color:#3f8058">}</span> 0u 20u 300u 10u <span style="color:#f44f4f">"$(DesktopIconPageCheckbox)"</span>
	pop $hwndChkDesktopIcon
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">If</span><span style="color:#3f8058">}</span> $CreateDesktopIcon <span style="color:#3f8058">==</span> 1
		$<span style="color:#3f8058">{</span>NSD_Check<span style="color:#3f8058">}</span> $hwndChkDesktopIcon
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">Else</span><span style="color:#3f8058">}</span>
		$<span style="color:#3f8058">{</span>NSD_Uncheck<span style="color:#3f8058">}</span> $hwndChkDesktopIcon
	$<span style="color:#3f8058">{</span><span style="color:#9500ff;font-weight:bold">EndIf</span><span style="color:#3f8058">}</span>
	$<span style="color:#3f8058">{</span>NSD_OnClick<span style="color:#3f8058">}</span> $hwndChkDesktopIcon func_DesktopShortcutPage_CheckChange

	$<span style="color:#3f8058">{</span>NSD_CreateLabel<span style="color:#3f8058">}</span> 0u 40u 300u 140u <span style="color:#f44f4f">"$(ConfirmInstallPageDesc2)"</span>
	pop $R0

	# TODO: Add install option summary for review<span style="color:#3f8058">?</span>

	nsDialogs::Show

	pop $R0
<span style="color:#0095ff;font-weight:bold">FunctionEnd</span>


# Strings
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"translations\English.nsh"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"translations\TradChinese.nsh"</span>
<span style="color:#3f8058">!</span><span style="font-weight:bold">include</span> <span style="color:#f44f4f">"translations\SimpChinese.nsh"</span>
</pre></body></html>
